apiVersion: v1
kind: Secret
metadata:
  name: microos1-userdata
  namespace: default
type: Opaque
stringData:
  userdata: |
    #cloud-config
    hostname: s01

    users:
      - name: root
        lock_passwd: false
        passwd: "$y$j9T$PPGS2ZmcEwK9Rva6ijffv.$FfSLRBTa9rctOyzshG6s77Gasi8pXaiInQ635D9TJZ5"
        ssh_authorized_keys:
          - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE4SrYkfM8Xu/9cFpqIOb8Y4OJ3WyPYJRB1zMOoTPJQN george@Georgioss-MacBook-Pro.local"

    ############################################################
    # NETWORKMANAGER (STATIC ENS18) + DISABLE AUTO ON ETHERNET
    ############################################################
    write_files:
      # Disable automatic DHCP/SLAAC on ethernet unless a matching profile exists
      - path: /etc/NetworkManager/conf.d/noauto.conf
        permissions: "0644"
        content: |
          [main]
          # Do not do automatic (DHCP/SLAAC) configuration on ethernet devices
          # with no other matching connections.
          no-auto-default=*

      # Static profile for ens18 (same structure as your Combustion file)
      - path: /etc/NetworkManager/system-connections/ens18.nmconnection
        permissions: "0600"
        content: |
          [connection]
          id=ens18
          type=ethernet
          interface-name=ens18

          [ipv4]
          method=manual
          address1=10.0.2.30,10.0.2.1
          dns=10.0.1.1
          dns-search=

          [ipv6]
          method=auto
          addr-gen-mode=eui64
          dns-search=

      # Marker to mirror your "Configured with combustion"
      - path: /etc/issue.d/combustion
        permissions: "0644"
        content: |
          Configured with combustion (via cloud-init migration)

    # MicroOS best practice: transactional-update (reboot required to finalize)
    runcmd:
      # Keyboard layout (equivalent to your systemd-firstboot call)
      - [ bash, -lc, "localectl set-keymap us-intl || true" ]
      # Install packages in a transactional way (preferred on MicroOS)
      - [ bash, -lc, "transactional-update --non-interactive pkg install python3 nfs-client open-iscsi || true" ]

      # NetworkManager: pick up our new profiles
      - [ bash, -lc, "nmcli connection reload || systemctl reload NetworkManager || true" ]
      - [ bash, -lc, "nmcli connection up ens18 || true" ]

    # Optional: automatically reboot once if transactional-update installed packages
    power_state:
      mode: reboot
      message: "Rebooting after transactional-update package install"
      condition: true
