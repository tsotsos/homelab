apiVersion: v1
kind: Secret
metadata:
  name: kng01-cloudinit-secret
  namespace: kng-cluster
stringData:
  userdata: |-
    #cloud-config
    ssh_pwauth: true
    write_files:
      - path: /etc/NetworkManager/system-connections/primary.nmconnection
        permissions: '0600'
        content: |
          [connection]
          id=primary
          type=ethernet
          interface-name=enp1s0
          autoconnect=true
          autoconnect-priority=100

          [ipv4]
          address1=10.0.2.50/24,10.0.2.1
          dns=10.0.1.1
          method=manual
          ignore-auto-dns=true
          ignore-auto-routes=true

          [ipv6]
          method=ignore

      - path: /var/lib/cloud/scripts/per-boot/20-net-static
        permissions: '0755'
        content: |
          #!/bin/sh
          PRIMARY="primary"
          IF="enp1s0"
          nmcli con load "/etc/NetworkManager/system-connections/${PRIMARY}.nmconnection" 2>/dev/null || true
          nmcli -t -f NAME,DEVICE con show | awk -F: -v iface="$IF" '$2==iface{print $1}' | while read -r C; do
            [ "$C" = "$PRIMARY" ] && continue
            nmcli con down "$C" 2>/dev/null || true
            nmcli con delete "$C" 2>/dev/null || true
          done
          nmcli con mod "$PRIMARY" connection.autoconnect yes connection.autoconnect-priority 100 ipv4.may-fail no
          nmcli con up "$PRIMARY" || true
    users:
      - name: root
        lock_passwd: false
        passwd: $6$MA6v7JyQGJABpN4F$eNXET.twXmaFBetvuqbxR5Vd7TjZkKrbE33keFr.XygHjyq220/cUyvIVFWp9hUhG66oh4lFum9V1jdQt4A/6.
        ssh_authorized_keys:
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE4SrYkfM8Xu/9cFpqIOb8Y4OJ3WyPYJRB1zMOoTPJQN george@Georgioss-MacBook-Pro.local
    chpasswd:
      expire: false
      list: |
        root:$6$MA6v7JyQGJABpN4F$eNXET.twXmaFBetvuqbxR5Vd7TjZkKrbE33keFr.XygHjyq220/cUyvIVFWp9hUhG66oh4lFum9V1jdQt4A/6.
    runcmd:
      - [ /usr/sbin/transactional-update, "-n", "run", "sh", "-c", "zypper -n in qemu-guest-agent && systemctl enable qemu-guest-agent.service" ]

    power_state:
      mode: reboot
      message: "Reboot to activate QGA snapshot"
      timeout: 30
      condition: true
type: Opaque
---
apiVersion: v1
kind: Secret
metadata:
  name: kng02-cloudinit-secret
  namespace: kng-cluster
stringData:
  userdata: |-
    #cloud-config
    ssh_pwauth: true
    write_files:
      - path: /etc/NetworkManager/system-connections/primary.nmconnection
        permissions: '0600'
        content: |
          [connection]
          id=primary
          type=ethernet
          interface-name=enp1s0
          autoconnect=true
          autoconnect-priority=100

          [ipv4]
          address1=10.0.2.51/24,10.0.2.1
          dns=10.0.1.1
          method=manual
          ignore-auto-dns=true
          ignore-auto-routes=true

          [ipv6]
          method=ignore

      - path: /var/lib/cloud/scripts/per-boot/20-net-static
        permissions: '0755'
        content: |
          #!/bin/sh
          PRIMARY="primary"
          IF="enp1s0"
          nmcli con load "/etc/NetworkManager/system-connections/${PRIMARY}.nmconnection" 2>/dev/null || true
          nmcli -t -f NAME,DEVICE con show | awk -F: -v iface="$IF" '$2==iface{print $1}' | while read -r C; do
            [ "$C" = "$PRIMARY" ] && continue
            nmcli con down "$C" 2>/dev/null || true
            nmcli con delete "$C" 2>/dev/null || true
          done
          nmcli con mod "$PRIMARY" connection.autoconnect yes connection.autoconnect-priority 100 ipv4.may-fail no
          nmcli con up "$PRIMARY" || true
    users:
      - name: root
        lock_passwd: false
        passwd: $6$MA6v7JyQGJABpN4F$eNXET.twXmaFBetvuqbxR5Vd7TjZkKrbE33keFr.XygHjyq220/cUyvIVFWp9hUhG66oh4lFum9V1jdQt4A/6.
        ssh_authorized_keys:
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE4SrYkfM8Xu/9cFpqIOb8Y4OJ3WyPYJRB1zMOoTPJQN george@Georgioss-MacBook-Pro.local
    chpasswd:
      expire: false
      list: |
        root:$6$MA6v7JyQGJABpN4F$eNXET.twXmaFBetvuqbxR5Vd7TjZkKrbE33keFr.XygHjyq220/cUyvIVFWp9hUhG66oh4lFum9V1jdQt4A/6.
    runcmd:
      - [ /usr/sbin/transactional-update, "-n", "run", "sh", "-c", "zypper -n in qemu-guest-agent && systemctl enable qemu-guest-agent.service" ]

    power_state:
      mode: reboot
      message: "Reboot to activate QGA snapshot"
      timeout: 30
      condition: true
type: Opaque
---
apiVersion: harvesterhci.io/v1beta1
kind: KeyPair
metadata:
  name: george
  namespace: default
spec:
  publicKey: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE4SrYkfM8Xu/9cFpqIOb8Y4OJ3WyPYJRB1zMOoTPJQN
    george@Georgioss-MacBook-Pro.local
---
apiVersion: harvesterhci.io/v1beta1
kind: VirtualMachineImage
metadata:
  name: microos-kvm
  namespace: default
spec:
  displayName: MicroOS KVM Image
  sourceType: download
  url: https://download.opensuse.org/tumbleweed/appliances/openSUSE-MicroOS.x86_64-ContainerHost-kvm-and-xen.qcow2
---
apiVersion: harvesterhci.io/v1beta1
kind: VirtualMachineImage
metadata:
  name: microos-openstack
  namespace: default
spec:
  displayName: MicroOS Openstack Image
  sourceType: download
  url: https://download.opensuse.org/tumbleweed/appliances/openSUSE-MicroOS.x86_64-ContainerHost-OpenStack-Cloud.qcow2
---
apiVersion: harvesterhci.io/v1beta1
kind: VirtualMachineImage
metadata:
  name: ubuntu-2403
  namespace: default
spec:
  displayName: Ubuntu 24.03 LTS
  sourceType: download
  url: https://cloud-images.ubuntu.com/releases/noble/release/ubuntu-24.04-server-cloudimg-amd64.img
---
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  annotations:
    harvesterhci.io/maintain-mode-strategy: ShutdownAndRestartAfterEnable
    harvesterhci.io/os: linux
    harvesterhci.io/vmRunStrategy: RerunOnFailure
  name: kng-01
  namespace: kng-cluster
spec:
  dataVolumeTemplates:
  - metadata:
      name: kng-01-disk
    spec:
      source:
        blank: {}
      storage:
        accessModes:
        - ReadWriteMany
        resources:
          requests:
            storage: 64Gi
        storageClassName: longhorn-microos-openstack
        volumeMode: Block
  runStrategy: RerunOnFailure
  template:
    spec:
      devices:
        disks:
        - bootOrder: 1
          disk:
            bus: virtio
          name: disk-0
        - disk:
            bus: virtio
          name: cloudinitdisk
        interfaces:
        - bridge: {}
          model: virtio
          name: default
      domain:
        cpu:
          cores: 2
          sockets: 1
          threads: 1
        memory:
          guest: 16Gi
      evictionStrategy: LiveMigrate
      hostname: kng-01
      networks:
      - multus:
          networkName: network
        name: default
      terminationGracePeriodSeconds: 120
      volumes:
      - dataVolume:
          name: kng-01-disk
        name: disk-0
      - cloudInitNoCloud:
          networkDataSecretRef:
            name: kng01-cloudinit-secret
          secretRef:
            name: kng01-cloudinit-secret
        name: cloudinitdisk
---
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  annotations:
    harvesterhci.io/maintain-mode-strategy: ShutdownAndRestartAfterEnable
    harvesterhci.io/os: linux
    harvesterhci.io/vmRunStrategy: RerunOnFailure
  name: kng-02
  namespace: kng-cluster
spec:
  dataVolumeTemplates:
  - metadata:
      name: kng-02-disk
    spec:
      source:
        blank: {}
      storage:
        accessModes:
        - ReadWriteMany
        resources:
          requests:
            storage: 64Gi
        storageClassName: longhorn-microos-openstack
        volumeMode: Block
  runStrategy: RerunOnFailure
  template:
    spec:
      devices:
        disks:
        - bootOrder: 1
          disk:
            bus: virtio
          name: disk-0
        - disk:
            bus: virtio
          name: cloudinitdisk
        interfaces:
        - bridge: {}
          model: virtio
          name: default
      domain:
        cpu:
          cores: 2
          sockets: 1
          threads: 1
        memory:
          guest: 16Gi
      evictionStrategy: LiveMigrate
      hostname: kng-02
      networks:
      - multus:
          networkName: network
        name: default
      terminationGracePeriodSeconds: 120
      volumes:
      - dataVolume:
          name: kng-02-disk
        name: disk-0
      - cloudInitNoCloud:
          networkDataSecretRef:
            name: kng02-cloudinit-secret
          secretRef:
            name: kng02-cloudinit-secret
        name: cloudinitdisk
