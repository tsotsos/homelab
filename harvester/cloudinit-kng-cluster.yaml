apiVersion: v1
kind: Secret
metadata:
  name: cloudinit-common
  namespace: kng-cluster
type: Opaque
stringData:
  networkdata: |
    version: 2
    ethernets:
      eth0:
        match: { name: "e*" }
        set-name: eth0
        dhcp4: false
        addresses: [10.0.2.50/24]
        routes:
          - to: 0.0.0.0/0
            via: 10.0.2.1
        nameservers:
          addresses: [10.0.1.1,1.1.1.1]
  userdata: |-
    #cloud-config
    ssh_pwauth: true
    disable_root: false
    users:
      - default
      - name: george
        groups: [sudo]
        shell: /bin/bash
        sudo: ALL=(ALL) NOPASSWD:ALL
        lock_passwd: false
        ssh_authorized_keys:
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE4SrYkfM8Xu/9cFpqIOb8Y4OJ3WyPYJRB1zMOoTPJQN george@Georgioss-MacBook-Pro.local
    chpasswd:
      expire: false
      list: |
        george:changeme123
        root:changeme123

    # ensure sshd allows password auth (override the “60-cloudimg” drop-in)
    write_files:
      - path: /etc/ssh/sshd_config.d/99-local.conf
        content: |
          PasswordAuthentication yes
          PubkeyAuthentication yes
          ChallengeResponseAuthentication no
          KbdInteractiveAuthentication no
      - path: /etc/modules-load.d/k8s.conf
        content: |
          br_netfilter
          overlay
      - path: /etc/sysctl.d/99-k8s.conf
        content: |
          net.ipv4.ip_forward=1
          net.bridge.bridge-nf-call-iptables=1
          net.bridge.bridge-nf-call-ip6tables=1
    packages:
      - openssh-server
      - qemu-guest-agent
    runcmd:
      - systemctl enable --now ssh || systemctl enable --now sshd
      - systemctl restart ssh || systemctl restart sshd
      - systemctl enable --now qemu-guest-agent
      - systemctl enable --now iscsid || true
      - swapoff -a
      - sed -i '/\sswap\s/ s/^/#/' /etc/fstab



