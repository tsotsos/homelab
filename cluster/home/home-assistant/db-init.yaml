---
# ConfigMap with bash script for idempotent database initialization
apiVersion: v1
kind: ConfigMap
metadata:
  name: homeassistant-db-init-script
  namespace: home-assistant
  annotations:
    argocd.argoproj.io/sync-wave: "-10"
data:
  init-db.sh: |
    #!/bin/bash
    set -e
    
    echo "Reading configuration from secrets..."
    # Read pre-defined credentials from home-assistant-secrets
    DB_USER=$(cat /app-secrets/postgres-user)
    DB_PASSWORD=$(cat /app-secrets/postgres-password)
    DB_NAME=$(cat /app-secrets/postgres-database)
    DB_HOST=$(cat /app-secrets/postgres-host)
    
    # Read postgres superuser password
    POSTGRES_PASSWORD=$(cat /pg-secrets/postgres-password)
    
    echo "Checking if database '${DB_NAME}' exists..."
    export PGPASSWORD="${POSTGRES_PASSWORD}"
    
    # Check if database exists
    DB_EXISTS=$(psql -h ${DB_HOST} -U postgres -tAc "SELECT 1 FROM pg_database WHERE datname='${DB_NAME}'")
    
    # Check if user exists
    USER_EXISTS=$(psql -h ${DB_HOST} -U postgres -tAc "SELECT 1 FROM pg_roles WHERE rolname='${DB_USER}'")
    
    if [ "$DB_EXISTS" = "1" ]; then
      echo "✓ Database '${DB_NAME}' already exists"
    else
      echo "Creating database '${DB_NAME}'..."
      psql -h ${DB_HOST} -U postgres -c "CREATE DATABASE ${DB_NAME};"
      echo "✓ Database created"
    fi
    
    if [ "$USER_EXISTS" = "1" ]; then
      echo "✓ User '${DB_USER}' already exists"
    else
      echo "Creating user '${DB_USER}'..."
      psql -h ${DB_HOST} -U postgres -c "CREATE USER ${DB_USER} WITH PASSWORD '${DB_PASSWORD}';"
      echo "✓ User created"
    fi
    
    # Always ensure proper ownership and privileges
    echo "Setting database owner and privileges..."
    psql -h ${DB_HOST} -U postgres -c "ALTER DATABASE ${DB_NAME} OWNER TO ${DB_USER};"
    psql -h ${DB_HOST} -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE ${DB_NAME} TO ${DB_USER};"
    
    # Grant schema privileges
    export PGPASSWORD="${DB_PASSWORD}"
    psql -h ${DB_HOST} -U ${DB_USER} -d ${DB_NAME} -c "GRANT ALL ON SCHEMA public TO ${DB_USER};"
    echo "✓ Database setup completed"
    
    echo "Database initialization finished successfully"
---
# Job to initialize Home Assistant database
apiVersion: batch/v1
kind: Job
metadata:
  name: homeassistant-db-init
  namespace: home-assistant
  annotations:
    argocd.argoproj.io/sync-wave: "-8"
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: homeassistant-db-init
      restartPolicy: OnFailure
      initContainers:
        - name: fetch-postgres-secret
          image: bitnami/kubectl:latest
          command:
            - sh
            - -c
            - |
              echo "Fetching PostgreSQL superuser password..."
              kubectl get secret postgresql-secrets -n postgresql -o jsonpath='{.data.postgres-password}' | base64 -d > /pg-secrets/postgres-password
              echo "✓ Secret fetched"
          volumeMounts:
            - name: pg-secrets
              mountPath: /pg-secrets
      containers:
        - name: init-db
          image: postgres:16-alpine
          command: ["/bin/bash", "/scripts/init-db.sh"]
          volumeMounts:
            - name: init-script
              mountPath: /scripts
            - name: pg-secrets
              mountPath: /pg-secrets
              readOnly: true
            - name: app-secrets
              mountPath: /app-secrets
              readOnly: true
      volumes:
        - name: init-script
          configMap:
            name: homeassistant-db-init-script
            defaultMode: 0755
        - name: pg-secrets
          emptyDir:
            medium: Memory
        - name: app-secrets
          secret:
            secretName: home-assistant-secrets
---
# ServiceAccount for database initialization
apiVersion: v1
kind: ServiceAccount
metadata:
  name: homeassistant-db-init
  namespace: home-assistant
  annotations:
    argocd.argoproj.io/sync-wave: "-10"
