# Home Assistant Configuration with PostgreSQL, InfluxDB, and Longhorn Storage

# Image configuration
image:
  repository: ghcr.io/home-assistant/home-assistant
  tag: "2025.12.0"  # Updated to match chart version
  pullPolicy: IfNotPresent

# Deployment strategy
strategy:
  type: Recreate  # Required for RWO storage

# Security context (needed for device access)
securityContext:
  privileged: true

# Service configuration
service:
  type: ClusterIP
  port: 8123
  annotations: {}

# Ingress configuration
ingress:
  enabled: true
  className: cilium
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-dns
    external-dns.alpha.kubernetes.io/hostname: home.kng.house
  hosts:
    - host: home.kng.house
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: homeassistant-tls
      hosts:
        - home.kng.house

# Persistence with Longhorn for configuration and backups
persistence:
  enabled: true
  storageClass: longhorn
  accessMode: ReadWriteOnce
  size: 20Gi
  # Mount path for Home Assistant config
  mountPath: /config

# Additional volumes for backups
additionalVolumes:
  - name: backups
    persistentVolumeClaim:
      claimName: homeassistant-backups
  - name: secrets
    secret:
      secretName: home-assistant-secrets

# Additional volume mounts
additionalVolumeMounts:
  - name: backups
    mountPath: /config/backups
  - name: secrets
    mountPath: /secrets
    readOnly: true

# Resources
resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: 2000m
    memory: 2Gi

# Node selector for stable nodes
nodeSelector:
  node.kng/workload-storage: "true"

# Probes
probes:
  liveness:
    enabled: true
    httpGet:
      path: /manifest.json
      port: http
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 5
  readiness:
    enabled: true
    httpGet:
      path: /manifest.json
      port: http
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

# Environment variables for database configuration
env:
  - name: TZ
    value: Europe/Athens
  - name: POSTGRES_URL
    valueFrom:
      secretKeyRef:
        name: home-assistant-secrets
        key: postgres-url
  # InfluxDB credentials (optional, can also be configured in configuration.yaml)
  - name: INFLUXDB_TOKEN
    valueFrom:
      secretKeyRef:
        name: home-assistant-secrets
        key: influxdb-token
  - name: INFLUXDB_URL
    valueFrom:
      secretKeyRef:
        name: home-assistant-secrets
        key: influxdb-url
  - name: INFLUXDB_ORG
    valueFrom:
      secretKeyRef:
        name: home-assistant-secrets
        key: influxdb-org
  - name: INFLUXDB_BUCKET
    valueFrom:
      secretKeyRef:
        name: home-assistant-secrets
        key: influxdb-bucket

# Init containers to ensure database is ready and configure integrations
initContainers:
  - name: create-configs
    image: busybox:latest
    command:
      - sh
      - -c
      - |
        # Only create files if they don't exist (preserves manual edits)
        if [ ! -f /config/http.yaml ]; then
          echo "Creating http.yaml..."
          cat > /config/http.yaml << 'EOF'
        # HTTP configuration for reverse proxy
        use_x_forwarded_for: true
        trusted_proxies:
          - 10.244.0.0/16  # Pod network CIDR
          - 10.0.2.0/24     # Load balancer network
        EOF
        else
          echo "✓ http.yaml already exists, skipping"
        fi
        
        if [ ! -f /config/recorder.yaml ]; then
          echo "Creating recorder.yaml..."
          cat > /config/recorder.yaml << 'EOF'
        # PostgreSQL database configuration
        db_url: !env_var POSTGRES_URL
        auto_purge: true
        purge_keep_days: 30
        commit_interval: 1
        EOF
        else
          echo "✓ recorder.yaml already exists, skipping"
        fi
        
        if [ ! -f /config/influxdb.yaml ]; then
          echo "Creating influxdb.yaml..."
          cat > /config/influxdb.yaml << 'EOF'
        # InfluxDB configuration for long-term metrics storage
        api_version: 2
        ssl: false
        host: influxdb-influxdb2.influxdb.svc.cluster.local
        port: 8086
        token: !env_var INFLUXDB_TOKEN
        organization: !env_var INFLUXDB_ORG
        bucket: !env_var INFLUXDB_BUCKET
        tags:
          source: homeassistant
        tags_attributes:
          - friendly_name
        default_measurement: units
        exclude:
          entities:
            - zone.home
          domains:
            - persistent_notification
            - person
        include:
          domains:
            - sensor
            - binary_sensor
            - light
            - switch
        EOF
        else
          echo "✓ influxdb.yaml already exists, skipping"
        fi
        
        # Update configuration.yaml only if includes are missing
        if [ -f /config/configuration.yaml ]; then
          if ! grep -q "http: !include http.yaml" /config/configuration.yaml; then
            echo "Adding http configuration to configuration.yaml"
            sed -i '/^default_config:/a\\n# HTTP configuration for reverse proxy\nhttp: !include http.yaml' /config/configuration.yaml
          else
            echo "✓ http include already present"
          fi
          
          if ! grep -q "recorder: !include recorder.yaml" /config/configuration.yaml; then
            echo "Adding recorder configuration to configuration.yaml"
            sed -i '/^default_config:/a\\n# PostgreSQL recorder\nrecorder: !include recorder.yaml' /config/configuration.yaml
          else
            echo "✓ recorder include already present"
          fi
          
          if ! grep -q "influxdb: !include influxdb.yaml" /config/configuration.yaml; then
            echo "Adding InfluxDB configuration to configuration.yaml"
            sed -i '/^default_config:/a\\n# InfluxDB metrics\ninfluxdb: !include influxdb.yaml' /config/configuration.yaml
          else
            echo "✓ influxdb include already present"
          fi
        fi
        echo "Configuration initialization complete"
    volumeMounts:
      - name: home-assistant
        mountPath: /config
  - name: wait-for-db
    image: postgres:16-alpine
    command:
      - sh
      - -c
      - |
        until pg_isready -h postgresql-primary.postgresql.svc.cluster.local -U homeassistant -d homeassistant; do
          echo "Waiting for PostgreSQL..."
          sleep 5
        done
        echo "PostgreSQL is ready!"
    env:
      - name: PGPASSWORD
        valueFrom:
          secretKeyRef:
            name: home-assistant-secrets
            key: postgres-password

# ServiceMonitor for Prometheus metrics
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s

# Pod annotations for backup scheduling
podAnnotations:
  backup.velero.io/backup-volumes: config,backups
  backup.longhorn.io/recurring-job-group: default

# Affinity rules
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: home-assistant
          topologyKey: kubernetes.io/hostname

# Addons configuration
addons:
  # Code Server (VS Code in browser for config editing)
  codeserver:
    enabled: true
    image:
      repository: ghcr.io/coder/code-server
      tag: "4.105.1"  # Chart default version
      pullPolicy: IfNotPresent
    auth:
      enabled: false  # Disable auth for now, can enable with secret later
    service:
      type: ClusterIP
      port: 12321  # Chart default port
    ingress:
      enabled: true
      className: cilium
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-dns
        external-dns.alpha.kubernetes.io/hostname: code-home.kng.house
      hosts:
        - host: code-home.kng.house
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: homeassistant-code-tls
          hosts:
            - code-home.kng.house
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
