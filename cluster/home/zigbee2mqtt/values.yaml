# Zigbee2MQTT Configuration using official Koenkk chart
image:
  repository: koenkk/zigbee2mqtt
  tag: null  # Use chart appVersion (2.7.1)
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 8080

# Disable direct ingress - using Authentik proxy
ingress:
  enabled: false

statefulset:

  # Disable liveness probe (no enabled flag in this chart, use empty object)
  livenessProbe: {}
  
  # Pod security context - disable seccomp profile that requires SYS_ADMIN
  podSecurityContext:
    seccompProfile:
      type: RuntimeDefault
  
  # Container security context - disable privileged mode (not needed for TCP adapter)
  securityContext:
    privileged: false
    capabilities:
      add: []
      drop:
        - ALL
  
  # Persistent storage - chart manages via volumeClaimTemplates
  storage:
    enabled: true
    size: 5Gi
    storageClassName: longhorn
  
  # Resources
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  
  # Init container to inject secrets into configuration
  initContainers:
    - name: config-injector
      image: python:3.11-alpine
      command: ["/bin/sh", "-c"]
      args:
        - |
          apk add --no-cache yq
          CONFIG_FILE="/data/configuration.yaml"
          
          echo "Checking configuration file..."
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Configuration file not found, will be created by main container"
            exit 0
          fi
          
          echo "Injecting network keys from secret..."
          yq eval ".advanced.network_key = env(Z2M_NETWORK_KEY)" -i "$CONFIG_FILE"
          yq eval ".advanced.ext_pan_id = env(Z2M_EXT_PAN_ID)" -i "$CONFIG_FILE"
          yq eval ".advanced.pan_id = env(Z2M_PAN_ID)" -i "$CONFIG_FILE"
          
          echo "Network keys injected successfully"
          
      env:
        - name: Z2M_NETWORK_KEY
          valueFrom:
            secretKeyRef:
              name: zigbee2mqtt-secrets
              key: network_key
        - name: Z2M_EXT_PAN_ID
          valueFrom:
            secretKeyRef:
              name: zigbee2mqtt-secrets
              key: ext_pan_id
        - name: Z2M_PAN_ID
          valueFrom:
            secretKeyRef:
              name: zigbee2mqtt-secrets
              key: pan_id
      volumeMounts:
        - name: data-volume
          mountPath: /data

# Zigbee2MQTT configuration
zigbee2mqtt:
  homeassistant:
    enabled: true
  
  permit_join: false
  
  mqtt:
    server: mqtt://emqx.emqx.svc.cluster.local:1883
    base_topic: zigbee2mqtt
  
  serial:
    port: tcp://10.0.5.11:6638
    adapter: ember
    baudrate: 115200
    disable_led: false
  
  frontend:
    enabled: true
    port: 8080
  
availability:
  enabled: true
  # Active devices = powered routers (bulbs/plugs/relays)
  active:
    timeout: 20
    # Optional fine-tuning to prevent aggressive ping storms on flaky links:
    pause_on_backoff_gt: 3
  # Passive devices = battery devices (sensors/buttons)
  passive:
    timeout: 740

  advanced:
    transmit_power: 20
    channel: 25
    # Keys injected from sealed-secret via init container
    # Will be populated at runtime - DO NOT add keys here
    log_level: info
    cache_state: true
    adapter_concurrent: null
    rtscts: false
    last_seen: ISO_8601
    
    # NETWORK RESET - Enable to reset network (WARNING: requires re-pairing ALL devices)
    force_network_reset: true
