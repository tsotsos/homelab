apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: zigbee2mqtt
  namespace: zigbee2mqtt
spec:
  serviceName: zigbee2mqtt
  replicas: 1
  selector:
    matchLabels:
      app: zigbee2mqtt
  template:
    metadata:
      labels:
        app: zigbee2mqtt
    spec:
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      initContainers:
      - name: config-setup
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          echo "Setting up configuration..."
          # Only copy if config doesn't exist (first time) or if explicitly requested
          if [ ! -f /app/data/configuration.yaml ]; then
            echo "First time setup - copying base configuration"
            cp /config/configuration.yaml /app/data/configuration.yaml
          else
            echo "Config exists - preserving devices section, updating base config only"
            # Extract devices section if it exists
            if grep -q "^devices:" /app/data/configuration.yaml; then
              sed -n '/^devices:/,$p' /app/data/configuration.yaml > /tmp/devices_section.yaml
            fi
            # Copy base config
            cp /config/configuration.yaml /app/data/configuration.yaml
            # Re-append devices section if we saved one
            if [ -f /tmp/devices_section.yaml ]; then
              cat /tmp/devices_section.yaml >> /app/data/configuration.yaml
              echo "Preserved existing device friendly names"
            fi
          fi
          
          # Replace placeholders with actual values from secrets
          sed -i "s|PLACEHOLDER_PAN_ID|$PAN_ID|g" /app/data/configuration.yaml
          sed -i "s|PLACEHOLDER_NETWORK_KEY|$NETWORK_KEY|g" /app/data/configuration.yaml
          sed -i "s|PLACEHOLDER_EXT_PAN_ID|$EXT_PAN_ID|g" /app/data/configuration.yaml
          
          echo "Configuration ready"
        env:
        - name: PAN_ID
          valueFrom:
            secretKeyRef:
              name: zigbee2mqtt-config
              key: pan_id
        - name: NETWORK_KEY
          valueFrom:
            secretKeyRef:
              name: zigbee2mqtt-config
              key: network_key
        - name: EXT_PAN_ID
          valueFrom:
            secretKeyRef:
              name: zigbee2mqtt-config
              key: ext_pan_id
        volumeMounts:
        - name: data
          mountPath: /app/data
        - name: config
          mountPath: /config
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
      containers:
      - name: zigbee2mqtt
        image: koenkk/zigbee2mqtt:2.7.2
        imagePullPolicy: IfNotPresent
        ports:
        - name: web
          containerPort: 8080
          protocol: TCP
        env:
        # MQTT configuration from sealed secret
        - name: ZIGBEE2MQTT_CONFIG_MQTT_SERVER
          valueFrom:
            secretKeyRef:
              name: zigbee2mqtt-config
              key: mqtt_server
        - name: ZIGBEE2MQTT_CONFIG_MQTT_USER
          valueFrom:
            secretKeyRef:
              name: zigbee2mqtt-config
              key: mqtt_user
        - name: ZIGBEE2MQTT_CONFIG_MQTT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: zigbee2mqtt-config
              key: mqtt_password
        - name: ZIGBEE2MQTT_CONFIG_MQTT_BASE_TOPIC
          valueFrom:
            secretKeyRef:
              name: zigbee2mqtt-config
              key: mqtt_base_topic
        # Serial/Coordinator configuration
        - name: ZIGBEE2MQTT_CONFIG_SERIAL_PORT
          valueFrom:
            secretKeyRef:
              name: zigbee2mqtt-config
              key: serial_port
        - name: ZIGBEE2MQTT_CONFIG_SERIAL_ADAPTER
          value: "ember"
        - name: ZIGBEE2MQTT_CONFIG_SERIAL_BAUDRATE
          value: "115200"
        - name: ZIGBEE2MQTT_CONFIG_SERIAL_DISABLE_LED
          value: "false"
        securityContext:
          privileged: false
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        volumeMounts:
        - name: data
          mountPath: /app/data
      volumes:
      - name: config
        configMap:
          name: zigbee2mqtt-config
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: longhorn
      resources:
        requests:
          storage: 5Gi
