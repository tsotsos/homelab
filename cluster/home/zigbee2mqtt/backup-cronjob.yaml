---
# Persistent volume for backups
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: zigbee2mqtt-backups
  namespace: zigbee2mqtt
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn
  resources:
    requests:
      storage: 5Gi
---
# CronJob to backup Zigbee2MQTT configuration
apiVersion: batch/v1
kind: CronJob
metadata:
  name: zigbee2mqtt-backup
  namespace: zigbee2mqtt
  labels:
    app: zigbee2mqtt-backup
spec:
  # Run daily at 3 AM
  schedule: "0 3 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: zigbee2mqtt-backup
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            seccompProfile:
              type: RuntimeDefault
          containers:
          - name: backup
            image: alpine:latest
            command:
              - sh
              - -c
              - |
                set -e
                
                echo "=== Zigbee2MQTT Backup Started ==="
                date
                
                # Install required tools
                apk add --no-cache tar gzip
                
                # Create backup directory with timestamp
                BACKUP_DATE=$(date +%Y%m%d-%H%M%S)
                BACKUP_DIR="/backups/zigbee2mqtt-backup-${BACKUP_DATE}"
                mkdir -p "$BACKUP_DIR"
                
                echo "Backup directory: $BACKUP_DIR"
                
                # Backup critical files
                echo "Backing up configuration files..."
                cp -v /data/configuration.yaml "$BACKUP_DIR/" || echo "⚠ configuration.yaml not found"
                cp -v /data/coordinator_backup.json "$BACKUP_DIR/" || echo "⚠ coordinator_backup.json not found"
                cp -v /data/database.db "$BACKUP_DIR/" || echo "⚠ database.db not found"
                cp -v /data/state.json "$BACKUP_DIR/" || echo "⚠ state.json not found"
                
                # Backup devices and groups
                if [ -d /data/devices ]; then
                  echo "Backing up devices..."
                  cp -r /data/devices "$BACKUP_DIR/"
                fi
                
                if [ -d /data/groups ]; then
                  echo "Backing up groups..."
                  cp -r /data/groups "$BACKUP_DIR/"
                fi
                
                # Create compressed archive
                echo "Creating compressed archive..."
                cd /backups
                tar -czf "zigbee2mqtt-backup-${BACKUP_DATE}.tar.gz" "zigbee2mqtt-backup-${BACKUP_DATE}"
                
                # Remove uncompressed backup
                rm -rf "$BACKUP_DIR"
                
                # Keep only last 30 backups
                echo "Cleaning up old backups (keeping last 30)..."
                ls -t /backups/zigbee2mqtt-backup-*.tar.gz | tail -n +31 | xargs -r rm -v
                
                # Show backup info
                echo ""
                echo "✓ Backup completed successfully"
                echo "Backup size: $(du -h /backups/zigbee2mqtt-backup-${BACKUP_DATE}.tar.gz | cut -f1)"
                echo ""
                echo "Available backups:"
                ls -lh /backups/zigbee2mqtt-backup-*.tar.gz | tail -5
                
                echo "=== Zigbee2MQTT Backup Finished ==="
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL
            volumeMounts:
            - name: data
              mountPath: /data
              readOnly: true
            - name: backups
              mountPath: /backups
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "256Mi"
                cpu: "200m"
          volumes:
          - name: data
            persistentVolumeClaim:
              claimName: data-volume-zigbee2mqtt-0
          - name: backups
            persistentVolumeClaim:
              claimName: zigbee2mqtt-backups
