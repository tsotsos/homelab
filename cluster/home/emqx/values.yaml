# EMQX Open Source Edition Configuration - High Availability

# Replica count for HA
replicaCount: 3

image:
  repository: emqx/emqx
  tag: "5.10.0"
  pullPolicy: IfNotPresent

# Service configuration
service:
  type: ClusterIP
  # MQTT port
  mqtt: 1883
  # MQTT over WebSocket
  mqttws: 8083
  # MQTT over SSL
  mqtts: 8883
  # MQTT over WSS
  mqttwss: 8084
  # Dashboard
  dashboard: 18083

# Disable direct ingress - using Authentik proxy
ingress:
  dashboard:
    enabled: false

# Persistent storage for HA cluster
persistence:
  enabled: true
  storageClassName: longhorn
  size: 5Gi
  accessMode: ReadWriteOnce

# EMQX Configuration
emqxConfig:
  # Cluster configuration for HA
  cluster:
    discovery_strategy: dns
    dns:
      # Service name for cluster discovery
      name: emqx-headless.emqx.svc.cluster.local
      record_type: srv
  
  # Listeners
  listeners:
    tcp:
      default:
        bind: "0.0.0.0:1883"
        max_connections: 1024000
    ws:
      default:
        bind: "0.0.0.0:8083"
        max_connections: 1024000
    ssl:
      default:
        bind: "0.0.0.0:8883"
        max_connections: 512000
    wss:
      default:
        bind: "0.0.0.0:8084"
        max_connections: 512000
  
  # Dashboard configuration
  dashboard:
    listeners:
      http:
        bind: "0.0.0.0:18083"
    default_username: admin
    default_password: public
  
  # Authentication - allow anonymous for now, can be restricted later
  authentication:
    - mechanism: password_based
      backend: built_in_database
      enable: true

# Resources for HA deployment
resources:
  requests:
    memory: "512Mi"
    cpu: "250m"
  limits:
    memory: "1Gi"
    cpu: "1000m"

# Anti-affinity to spread pods across nodes
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - emqx
          topologyKey: kubernetes.io/hostname

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

# Pod disruption budget for HA
podDisruptionBudget:
  enabled: true
  minAvailable: 2

# Health checks
livenessProbe:
  enabled: true
  httpGet:
    path: /status
    port: 18083
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 3

readinessProbe:
  enabled: true
  httpGet:
    path: /status
    port: 18083
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
