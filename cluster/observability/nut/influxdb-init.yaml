---
# ConfigMap with script for idempotent InfluxDB token initialization for NUT/Telegraf
apiVersion: v1
kind: ConfigMap
metadata:
  name: nut-influxdb-init-script
  namespace: observability
data:
  init-influxdb.sh: |
    #!/bin/sh
    set -e
    
    echo "Installing dependencies..."
    apk add --no-cache curl jq || {
      echo "Failed to install curl/jq"
      exit 1
    }
    
    echo "Reading configuration..."
    BUCKET="default"
    ORG="influxdata"
    INFLUX_URL="http://influxdb-influxdb2.observability.svc.cluster.local:8086"
    ADMIN_TOKEN=$(cat /influx-secrets/admin-token)
    
    if [ -z "$ADMIN_TOKEN" ]; then
      echo "ERROR: Admin token is empty"
      exit 1
    fi
    echo "Admin token loaded (${#ADMIN_TOKEN} chars)"
    
    echo "Testing InfluxDB connectivity..."
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${INFLUX_URL}/health")
    echo "InfluxDB health check: HTTP ${HTTP_CODE}"
    
    echo "Fetching all organizations..."
    ALL_ORGS=$(curl -s --max-time 10 -H "Authorization: Token ${ADMIN_TOKEN}" "${INFLUX_URL}/api/v2/orgs")
    echo "All orgs: ${ALL_ORGS}"
    
    echo "Looking for organization ID for '${ORG}'..."
    ORG_ID=$(echo "${ALL_ORGS}" | jq -r ".orgs[] | select(.name==\"${ORG}\") | .id")
    
    if [ -z "$ORG_ID" ] || [ "$ORG_ID" = "null" ]; then
      echo "Organization '${ORG}' not found by name, using hardcoded ID..."
      ORG_ID="0bcf1077828e1514"
    fi
    echo "Organization ID: ${ORG_ID}"
    
    echo "Fetching bucket ID for '${BUCKET}'..."
    BUCKET_ID=$(curl -s --max-time 10 -H "Authorization: Token ${ADMIN_TOKEN}" "${INFLUX_URL}/api/v2/buckets?org=${ORG}&name=${BUCKET}" | jq -r ".buckets[]? | select(.name==\"${BUCKET}\") | .id")
    
    if [ -z "$BUCKET_ID" ] || [ "$BUCKET_ID" = "null" ]; then
      echo "Failed to get bucket ID for '${BUCKET}'"
      exit 1
    fi
    echo "Bucket ID: ${BUCKET_ID}"

    EXISTING_TOKEN=$(cat /app-secrets/influxdb-nut-token 2>/dev/null || echo "")
    if [ -n "$EXISTING_TOKEN" ]; then
      TOKEN_CHECK=$(curl -s -H "Authorization: Token ${EXISTING_TOKEN}" "${INFLUX_URL}/api/v2/buckets?org=${ORG}")
      if echo "$TOKEN_CHECK" | jq -e '.buckets' > /dev/null 2>&1; then
        echo "skip" > /shared/status
        exit 0
      fi
    fi

    echo "Checking for existing nut-telegraf-token..."
    EXISTING_AUTH=$(curl -s -H "Authorization: Token ${ADMIN_TOKEN}" "${INFLUX_URL}/api/v2/authorizations" | jq -r '.authorizations[] | select(.description=="nut-telegraf-token") | .token' | head -1)
    if [ -n "$EXISTING_AUTH" ] && [ "$EXISTING_AUTH" != "null" ]; then
      echo "Found existing token"
      NEW_TOKEN="$EXISTING_AUTH"
    else
      echo "Creating new token..."
      TOKEN_RESPONSE=$(curl -s -X POST -H "Authorization: Token ${ADMIN_TOKEN}" -H "Content-Type: application/json" "${INFLUX_URL}/api/v2/authorizations" -d "{\"orgID\":\"${ORG_ID}\",\"description\":\"nut-telegraf-token\",\"permissions\":[{\"action\":\"write\",\"resource\":{\"type\":\"buckets\",\"id\":\"${BUCKET_ID}\",\"orgID\":\"${ORG_ID}\"}}]}")
      echo "Token response: ${TOKEN_RESPONSE}"
      NEW_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.token')
      if [ -z "$NEW_TOKEN" ] || [ "$NEW_TOKEN" = "null" ]; then
        echo "Failed to create token"
        exit 1
      fi
      echo "Token created successfully"
    fi

    echo "Storing token (${#NEW_TOKEN} chars)..."
    echo -n "${NEW_TOKEN}" > /shared/token
    echo "done" > /shared/status
    echo "Initialization complete"
---
# ServiceAccount for the init job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nut-influxdb-init
  namespace: observability
---
# RBAC: allow nut-influxdb-init to patch secrets in observability namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: nut-influxdb-init-patch
  namespace: observability
rules:
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["nut-influxdb-secrets"]
  verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: nut-influxdb-init-patch
  namespace: observability
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: nut-influxdb-init-patch
subjects:
- kind: ServiceAccount
  name: nut-influxdb-init
  namespace: observability
---
# Job to initialize the NUT/Telegraf InfluxDB token
apiVersion: batch/v1
kind: Job
metadata:
  name: nut-influxdb-init
  namespace: observability
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: nut-influxdb-init
      restartPolicy: OnFailure
      initContainers:
        - name: fetch-influxdb-secret
          image: bitnami/kubectl:latest
          command:
            - sh
            - -c
            - |
              kubectl get secret influxdb-auth -n observability -o jsonpath='{.data.admin-token}' | base64 -d > /influx-secrets/admin-token
          volumeMounts:
            - name: influx-secrets
              mountPath: /influx-secrets
      containers:
        - name: init-influxdb
          image: alpine:latest
          command: ["/bin/sh", "/scripts/init-influxdb.sh"]
          volumeMounts:
            - name: init-script
              mountPath: /scripts
            - name: influx-secrets
              mountPath: /influx-secrets
              readOnly: true
            - name: app-secrets
              mountPath: /app-secrets
              readOnly: true
            - name: shared
              mountPath: /shared
        - name: token-patcher
          image: bitnami/kubectl:latest
          command:
            - sh
            - -c
            - |
              while [ ! -f /shared/status ]; do sleep 1; done
              STATUS=$(cat /shared/status)
              echo "Status: $STATUS"
              if [ "$STATUS" = "done" ]; then
                TOKEN=$(cat /shared/token)
                echo "Token length: ${#TOKEN}"
                echo "Token (first 20 chars): ${TOKEN:0:20}..."
                TOKEN_BASE64=$(echo -n "${TOKEN}" | base64 -w0)
                echo "Base64 length: ${#TOKEN_BASE64}"
                echo "Patching secret..."
                kubectl patch secret nut-influxdb-secrets -n observability --type='json' -p="[{\"op\":\"replace\",\"path\":\"/data/influxdb-nut-token\",\"value\":\"${TOKEN_BASE64}\"}]"
                echo "Patch complete"
              fi
          volumeMounts:
            - name: shared
              mountPath: /shared
      volumes:
        - name: init-script
          configMap:
            name: nut-influxdb-init-script
            defaultMode: 0755
        - name: influx-secrets
          emptyDir: {}
        - name: shared
          emptyDir: {}
        - name: app-secrets
          secret:
            secretName: nut-influxdb-secrets
