apiVersion: apps/v1
kind: Deployment
metadata:
  name: nut-server
  namespace: monitoring
  labels:
    app: nut-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nut-server
  template:
    metadata:
      labels:
        app: nut-server
    spec:
      containers:
      - name: nut-upsd
        image: instantlinux/nut-upsd:latest
        imagePullPolicy: IfNotPresent
        command:
        - sh
        - -c
        - |
          set -e
          
          # Create config files directly
          cat > /etc/nut/ups.conf <<'EOF'
          [ups1]
            driver = snmp-ups
            port = 10.0.1.8
            snmp_version = v2c
            community = public
            mibs = apcc
            desc = "UPS 10.0.1.8"

          [pdu1]
            driver = snmp-ups
            port = 10.0.1.9
            snmp_version = v1
            community = network
            mibs = apc_pdu
            pollfreq = 30
            desc = "PDU 10.0.1.9"

          [pdu2]
            driver = snmp-ups
            port = 10.0.1.10
            snmp_version = v1
            community = network
            mibs = apc_pdu
            pollfreq = 30
            desc = "PDU 10.0.1.10"
          EOF

          cat > /etc/nut/upsd.conf <<'EOF'
          LISTEN 0.0.0.0 3493
          EOF

          cat > /etc/nut/upsd.users <<'EOF'
          [admin]
            password = adminpass
            actions = SET
            instcmds = ALL

          [mon]
            password = monpass
            upsmon slave
          EOF

          cat > /etc/nut/upsmon.conf <<'EOF'
          MONITOR ups1@localhost 1 mon monpass master
          MINSUPPLIES 1
          SHUTDOWNCMD "/sbin/shutdown -h +0"
          EOF

          cat > /etc/nut/nut.conf <<'EOF'
          MODE=netserver
          EOF

          mkdir -p /var/run/nut
          chmod 640 /etc/nut/*
          chown -R nut:nut /etc/nut /var/run/nut
          
          echo "Starting NUT drivers..."
          upsdrvctl -u nut start &
          sleep 5
          echo "Starting upsd..."
          exec upsd -D -u nut
        ports:
        - containerPort: 3493
          name: nut
          protocol: TCP
        env:
        - name: DISABLE_USB
          value: "true"
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            memory: 128Mi
      - name: nut-exporter
        image: ghcr.io/druggeri/nut_exporter:3.1.1
        imagePullPolicy: IfNotPresent
        args:
        - --nut.server=127.0.0.1
        - --nut.vars_enable=battery.charge,battery.runtime,battery.voltage,battery.date,battery.packs,battery.runtime.low,input.voltage,input.frequency,input.voltage.maximum,input.voltage.minimum,input.transfer.high,input.transfer.low,output.voltage,output.current,output.frequency,output.voltage.nominal,ups.load,ups.status,ups.temperature,ups.power,ups.realpower,ups.test.result,ups.firmware,ups.mfr.date,outlet.count,outlet.1.status,outlet.2.status,outlet.3.status,outlet.4.status,outlet.5.status,outlet.6.status,outlet.7.status,outlet.8.status
        env:
        - name: NUT_EXPORTER_USERNAME
          value: "mon"
        - name: NUT_EXPORTER_PASSWORD
          value: "monpass"
        ports:
        - containerPort: 9199
          name: metrics
          protocol: TCP
        resources:
          requests:
            cpu: 50m
            memory: 32Mi
          limits:
            memory: 64Mi
      - name: peanut
        image: brandawg93/peanut:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: WEB_PORT
          value: "8080"
        - name: WEB_HOST
          value: "0.0.0.0"
        ports:
        - containerPort: 8080
          name: web
          protocol: TCP
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            memory: 256Mi
        volumeMounts:
        - name: peanut-config
          mountPath: /config
      volumes:
      - name: peanut-config
        emptyDir: {}
