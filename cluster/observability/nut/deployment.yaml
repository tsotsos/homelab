apiVersion: apps/v1
kind: Deployment
metadata:
  name: nut-server
  namespace: monitoring
  labels:
    app: nut-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nut-server
  template:
    metadata:
      labels:
        app: nut-server
    spec:
      initContainers:
      - name: nut-config-setup
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          cp /config-source/* /etc/nut/
          chmod 640 /etc/nut/*
          # Create nut.conf with required MODE setting
          echo "MODE=netserver" > /etc/nut/nut.conf
        volumeMounts:
        - name: nut-config-source
          mountPath: /config-source
        - name: nut-config-rw
          mountPath: /etc/nut
      containers:
      - name: nut-upsd
        image: debian:bookworm-slim
        imagePullPolicy: IfNotPresent
        command:
        - bash
        - -c
        - |
          set -e
          echo "Installing NUT with SNMP support..."
          apt-get update -qq
          apt-get install -y --no-install-recommends nut-snmp nut-server
          
          echo "Creating runtime directory..."
          mkdir -p /var/run/nut
          chown -R nut:nut /var/run/nut /etc/nut
          chmod 640 /etc/nut/*
          
          echo "Starting SNMP drivers for APC devices..."
          # UPS at 10.0.1.8
          /lib/nut/snmp-ups -a apc-ups-main -u nut &
          # PDU at 10.0.1.9
          /lib/nut/snmp-ups -a apc-pdu-net -u nut &
          # PDU at 10.0.1.10
          /lib/nut/snmp-ups -a apc-pdu-srv -u nut &
          
          echo "Waiting for drivers to connect..."
          sleep 15
          
          echo "Starting upsd daemon..."
          exec /sbin/upsd -D -u nut
        ports:
        - containerPort: 3493
          name: nut
          protocol: TCP
        env:
        - name: DISABLE_USB
          value: "true"
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            memory: 128Mi
        volumeMounts:
        - name: nut-config-rw
          mountPath: /etc/nut
      - name: nut-exporter
        image: hon95/prometheus-nut-exporter:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9199
          name: metrics
          protocol: TCP
        env:
        - name: NUT_EXPORTER_SERVER
          value: "127.0.0.1"
        - name: NUT_EXPORTER_PORT
          value: "3493"
        - name: NUT_EXPORTER_USERNAME
          value: "mon"
        - name: NUT_EXPORTER_PASSWORD
          value: "monpass"
        resources:
          requests:
            cpu: 50m
            memory: 32Mi
          limits:
            memory: 64Mi
      volumes:
      - name: nut-config-source
        secret:
          secretName: nut-config
      - name: nut-config-rw
        emptyDir: {}
