apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprints
  namespace: authentik
  labels:
    blueprints.goauthentik.io/discover: "true"
data:
  applications.yaml: |-
    version: 1
    metadata:
      name: homelab-applications
      labels:
        blueprints.goauthentik.io/instantiate: "true"

    entries:
      # ==================== Zigbee2MQTT ====================
      - model: authentik_providers_proxy.proxyprovider
        id: zigbee2mqtt-provider
        identifiers:
          name: zigbee2mqtt-proxy
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
          external_host: https://z2m.kng.house
          internal_host: http://zigbee2mqtt.home.svc.cluster.local:8080
          mode: forward_single
          
      - model: authentik_core.application
        identifiers:
          slug: zigbee2mqtt
        attrs:
          name: Zigbee2MQTT
          provider: !KeyOf zigbee2mqtt-provider
          group: Home Automation
          meta_icon: https://raw.githubusercontent.com/Koenkk/zigbee2mqtt/master/images/logo.png
          meta_description: Zigbee to MQTT bridge
          policy_engine_mode: all
          open_in_new_tab: true

      # ==================== EMQX Dashboard ====================
      - model: authentik_providers_proxy.proxyprovider
        id: emqx-provider
        identifiers:
          name: emqx-proxy
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
          external_host: https://emqx.kng.house
          internal_host: http://emqx.home.svc.cluster.local:18083
          mode: forward_single
          
      - model: authentik_core.application
        identifiers:
          slug: emqx
        attrs:
          name: EMQX Dashboard
          provider: !KeyOf emqx-provider
          group: Home Automation
          meta_icon: https://www.emqx.io/favicon.ico
          meta_description: MQTT Broker Dashboard
          policy_engine_mode: all
          open_in_new_tab: true

      # ==================== Longhorn ====================
      - model: authentik_providers_proxy.proxyprovider
        id: longhorn-provider
        identifiers:
          name: longhorn-proxy
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
          internal_host: http://longhorn-frontend.longhorn-system.svc.cluster.local:80
          external_host: https://longhorn.kng.house
          mode: forward_single
          
      - model: authentik_core.application
        identifiers:
          slug: longhorn
        attrs:
          name: Longhorn
          provider: !KeyOf longhorn-provider
          group: Infrastructure
          meta_icon: https://longhorn.io/img/logos/longhorn-icon-color.png
          meta_description: Kubernetes Storage Management
          policy_engine_mode: all
          open_in_new_tab: true

      # ==================== Code Server ====================
      - model: authentik_providers_proxy.proxyprovider
        id: code-server-provider
        identifiers:
          name: code-server-proxy
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
          external_host: https://code.kng.house
          internal_host: http://code-server.default.svc.cluster.local:8080
          mode: forward_single
          
      - model: authentik_core.application
        identifiers:
          slug: code-server
        attrs:
          name: Code Server
          provider: !KeyOf code-server-provider
          group: Development
          meta_icon: https://raw.githubusercontent.com/coder/code-server/main/src/browser/media/pwa-icon-512.png
          meta_description: VS Code in the browser
          policy_engine_mode: all
          open_in_new_tab: true

      # ==================== NUT (Peanut) ====================
      - model: authentik_providers_proxy.proxyprovider
        id: peanut-provider
        identifiers:
          name: peanut-proxy
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
          internal_host: http://nut-server.observability.svc.cluster.local:8080
          external_host: https://peanut.kng.house
          mode: forward_single
          
      - model: authentik_core.application
        identifiers:
          slug: peanut
        attrs:
          name: Peanut UPS
          provider: !KeyOf peanut-provider
          group: Infrastructure
          meta_icon: https://networkupstools.org/images/nut-logo.png
          meta_description: UPS Monitoring
          policy_engine_mode: all
          open_in_new_tab: true

  outpost-config.yaml: |-
    version: 1
    metadata:
      name: outpost-configuration
      labels:
        blueprints.goauthentik.io/instantiate: "true"

    entries:
      # Update the embedded outpost to include all applications
      - model: authentik_outposts.outpost
        identifiers:
          name: authentik Embedded Outpost
        attrs:
          type: proxy
          config:
            log_level: info
            docker_network: null
            docker_map_ports: true
            container_image: null
            kubernetes_replicas: 1
            kubernetes_namespace: authentik
          providers:
            - !Find [authentik_providers_proxy.proxyprovider, [name, zigbee2mqtt-proxy]]
            - !Find [authentik_providers_proxy.proxyprovider, [name, emqx-proxy]]
            - !Find [authentik_providers_proxy.proxyprovider, [name, longhorn-proxy]]
            - !Find [authentik_providers_proxy.proxyprovider, [name, code-server-proxy]]
            - !Find [authentik_providers_proxy.proxyprovider, [name, peanut-proxy]]

