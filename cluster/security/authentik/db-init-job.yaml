---
apiVersion: batch/v1
kind: Job
metadata:
  name: authentik-db-init
  namespace: authentik
  annotations:
    argocd.argoproj.io/sync-wave: "-5"
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      name: authentik-db-init
    spec:
      serviceAccountName: authentik-db-init
      restartPolicy: OnFailure
      initContainers:
      # Get PostgreSQL admin password from postgresql namespace
      - name: fetch-postgres-password
        image: bitnami/kubectl:latest
        command:
        - sh
        - -c
        - |
          kubectl get secret postgresql-secrets -n postgresql -o jsonpath='{.data.postgres-password}' | base64 -d > /shared/postgres-password
        volumeMounts:
        - name: shared-data
          mountPath: /shared
      containers:
      - name: db-init
        image: postgres:16-alpine
        command:
        - /bin/sh
        - -c
        - |
          set -e
          export PGPASSWORD=$(cat /shared/postgres-password)
          
          echo "Connecting to PostgreSQL at ${POSTGRES_HOST}..."
          
          # Wait for PostgreSQL to be reachable
          for i in $(seq 1 30); do
            if psql -h "${POSTGRES_HOST}" -U postgres -c "SELECT 1" > /dev/null 2>&1; then
              echo "PostgreSQL is reachable"
              break
            fi
            echo "Attempt $i: PostgreSQL not reachable yet, waiting..."
            sleep 2
          done
          
          echo "Checking if database 'authentik' exists..."
          
          # Check if database exists
          DB_EXISTS=$(psql -h "${POSTGRES_HOST}" -U postgres -tAc "SELECT 1 FROM pg_database WHERE datname='authentik'" 2>/dev/null || echo "0")
          
          if [ "$DB_EXISTS" = "1" ]; then
            echo "Database 'authentik' already exists. Skipping creation."
          else
            echo "Database 'authentik' does not exist. Creating..."
            
            # Create user if not exists
            psql -h "${POSTGRES_HOST}" -U postgres -c "
              DO \$\$
              BEGIN
                IF NOT EXISTS (SELECT FROM pg_catalog.pg_user WHERE usename = 'authentik') THEN
                  CREATE USER authentik WITH PASSWORD '${AUTHENTIK_DB_PASSWORD}';
                END IF;
              END
              \$\$;
            "
            
            # Create database
            psql -h "${POSTGRES_HOST}" -U postgres -c "
              CREATE DATABASE authentik OWNER authentik;
            "
            
            # Grant privileges
            psql -h "${POSTGRES_HOST}" -U postgres -c "
              GRANT ALL PRIVILEGES ON DATABASE authentik TO authentik;
            "
            
            echo "Database 'authentik' created successfully."
          fi
          
          echo "Database initialization complete."
        env:
        - name: POSTGRES_HOST
          value: "postgresql-primary.postgresql"
        - name: AUTHENTIK_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: authentik-secrets
              key: postgresql-password
        volumeMounts:
        - name: shared-data
          mountPath: /shared
      volumes:
      - name: shared-data
        emptyDir: {}
