alloy:
  configMap:
    create: true
    content: |
      // Kubernetes pod logs
      discovery.kubernetes "pods" {
        role = "pod"
      }

      discovery.relabel "pods" {
        targets = discovery.kubernetes.pods.targets
        
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_pod_node_name"]
          target_label  = "node"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
          target_label  = "app"
        }
      }

      loki.source.kubernetes "pods" {
        targets    = discovery.relabel.pods.output
        forward_to = [loki.process.pods.receiver]
      }

      loki.process "pods" {
        stage.static_labels {
          values = {
            cluster      = "kng",
            device_type  = "kubernetes",
            service_name = "kubernetes",
          }
        }
        
        forward_to = [loki.write.default.receiver]
      }

      // UniFi syslog receiver (UDP) - handles CEF format
      loki.source.syslog "unifi" {
        listener {
          address  = "0.0.0.0:514"
          protocol = "udp"
          labels   = {
            cluster      = "kng",
            job          = "unifi",
          }
        }
        forward_to = [loki.process.unifi_cef.receiver]
      }

      // UniFi syslog receiver (TCP)
      loki.source.syslog "unifi_tcp" {
        listener {
          address  = "0.0.0.0:1514"
          protocol = "tcp"
          labels   = {
            cluster      = "kng",
            job          = "unifi",
          }
        }
        forward_to = [loki.process.unifi_cef.receiver]
      }

      // Process UniFi CEF logs
      loki.process "unifi_cef" {
        // Extract CEF format: CEF:version|vendor|product|product_version|signature|name|severity|extensions
        stage.regex {
          expression = "CEF:(?P<version>\\d+)\\|(?P<vendor>[^|]*)\\|(?P<product>[^|]*)\\|(?P<product_version>[^|]*)\\|(?P<signature>[^|]*)\\|(?P<name>[^|]*)\\|(?P<severity>[^|]*)\\|(?P<ext>.*)"
        }
        
        stage.labels {
          values = {
            severity = "",
            vendor = "",
            product = "",
            event_name = "name",
          }
        }
        
        // Extract device name from extensions (UNIFIconnectedToDeviceName or UNIFIhost)
        stage.regex {
          source = "ext"
          expression = "UNIFIconnectedToDeviceName=(?P<device_name>[^ ]+)"
        }
        
        stage.regex {
          source = "ext"
          expression = "UNIFIhost=(?P<unifi_host>[^ ]+)"
        }
        
        stage.labels {
          values = {
            device_name = "",
            host = "unifi_host",
          }
        }
        
        // Detect device type from device name
        stage.match {
          selector = "{device_name=~\".*[Uu][Dd][Mm].*\"}"
          stage.static_labels {
            values = {
              device_type = "udm",
            }
          }
        }
        
        stage.match {
          selector = "{device_name=~\".*[Ss]witch.*|.*[Uu][Ss][Ww].*\"}"
          stage.static_labels {
            values = {
              device_type = "usw",
            }
          }
        }
        
        stage.match {
          selector = "{device_name=~\".*[Aa][Pp].*|.*[Uu]6.*\"}"
          stage.static_labels {
            values = {
              device_type = "uap",
            }
          }
        }
        
        forward_to = [loki.write.default.receiver]
      }

      // HTTP receiver for application logs
      loki.source.api "http" {
        http {
          listen_address = "0.0.0.0"
          listen_port    = 8080
        }
        forward_to = [loki.process.http.receiver]
      }

      loki.process "http" {
        stage.static_labels {
          values = {
            cluster      = "kng",
            device_type  = "http",
            service_name = "http",
          }
        }
        
        forward_to = [loki.write.default.receiver]
      }

      // Write to Loki
      loki.write "default" {
        endpoint {
          url = "http://loki-gateway.loki.svc.cluster.local/loki/api/v1/push"
        }
      }

controller:
  type: "daemonset"

service:
  type: LoadBalancer
  ports:
    - name: syslog-udp
      port: 514
      targetPort: 514
      protocol: UDP
    - name: syslog-tcp
      port: 1514
      targetPort: 1514
      protocol: TCP
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP

ingress:
  enabled: true
  ingressClassName: cilium
  hosts:
    - logs.kng.house
  tls:
    - secretName: logs-kng-house-tls
      hosts:
        - logs.kng.house

serviceMonitor:
  enabled: true
  namespace: alloy
