alloy:
  extraPorts:
    - name: "syslog-udp"
      port: 514
      targetPort: 514
      protocol: "UDP"
    - name: "syslog-tcp"
      port: 1514
      targetPort: 1514
      protocol: "TCP"
    - name: "nut-ups"
      port: 5514
      targetPort: 5514
      protocol: "UDP"
    - name: "proxmox"
      port: 6514
      targetPort: 6514
      protocol: "UDP"
    - name: "http"
      port: 8080
      targetPort: 8080
      protocol: "TCP"
  
  configMap:
    create: true
    content: |
      // ============================================================================
      // KUBERNETES POD LOGS
      // ============================================================================
      discovery.kubernetes "pods" {
        role = "pod"
      }

      discovery.relabel "pods" {
        targets = discovery.kubernetes.pods.targets
        
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_pod_node_name"]
          target_label  = "node"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
          target_label  = "app"
        }
      }

      loki.source.kubernetes "pods" {
        targets    = discovery.relabel.pods.output
        forward_to = [loki.process.kubernetes.receiver]
      }

      loki.process "kubernetes" {
        stage.static_labels {
          values = {
            cluster      = "kng",
            device_type  = "kubernetes",
            source       = "k8s-logs",
          }
        }
        
        forward_to = [loki.write.default.receiver]
      }

      // ============================================================================
      // UNIFI NETWORK DEVICES - CEF FORMAT
      // ============================================================================
      loki.source.syslog "unifi_udp" {
        listener {
          address  = "0.0.0.0:514"
          protocol = "udp"
          labels   = {
            cluster = "kng",
            source  = "syslog-udp",
          }
        }
        forward_to = [loki.process.unifi.receiver]
      }

      loki.source.syslog "unifi_tcp" {
        listener {
          address  = "0.0.0.0:1514"
          protocol = "tcp"
          labels   = {
            cluster = "kng",
            source  = "syslog-tcp",
          }
        }
        forward_to = [loki.process.unifi.receiver]
      }

      loki.process "unifi" {
        // Add job label first
        stage.static_labels {
          values = {
            job = "unifi",
          }
        }
        
        // Parse CEF format: CEF:version|vendor|product|version|signature|name|severity|extensions
        stage.regex {
          expression = "CEF:(?P<cef_version>\\d+)\\|(?P<vendor>[^|]*)\\|(?P<product>[^|]*)\\|(?P<product_version>[^|]*)\\|(?P<signature>[^|]*)\\|(?P<event_name>[^|]*)\\|(?P<severity>[^|]*)\\|(?P<extensions>.*)"
        }
        
        // Extract device info from CEF extensions
        stage.regex {
          source     = "extensions"
          expression = "UNIFIconnectedToDeviceName=(?P<connected_device>[^ ]+)"
        }
        
        stage.regex {
          source     = "extensions"
          expression = "UNIFIhost=(?P<unifi_host>[^\\s]+(?:\\s+[^\\s]+)*?)(?:\\s+UNIFI|$)"
        }
        
        stage.regex {
          source     = "extensions"
          expression = "UNIFIclientHostname=(?P<client_hostname>[^ ]+)"
        }
        
        // Set labels from extracted values
        stage.labels {
          values = {
            vendor       = "",
            product      = "",
            severity     = "",
            event_name   = "",
            device_name  = "connected_device",
            host         = "unifi_host",
            client       = "client_hostname",
          }
        }
        
        // Detect device type from device name
        stage.match {
          selector = "{device_name=~\".+\"}"
          
          stage.regex {
            source     = "device_name"
            expression = "(?i)^(?P<device_prefix>udm|usw|uap|u6|usg|uck)"
          }
          
          stage.labels {
            values = {
              device_type = "device_prefix",
            }
          }
        }
        
        // Fallback: detect from host if device_name not present
        stage.match {
          selector = "{device_type=\"\",host=~\".+\"}"
          
          stage.regex {
            source     = "host"
            expression = "(?i)(?P<host_prefix>udm|usw|uap|u6|usg|uck)"
          }
          
          stage.labels {
            values = {
              device_type = "host_prefix",
            }
          }
        }
        
        // Default device_type if still empty
        stage.match {
          selector = "{device_type=\"\"}"
          
          stage.static_labels {
            values = {
              device_type = "unifi",
            }
          }
        }
        
        forward_to = [loki.write.default.receiver]
      }

      // ============================================================================
      // UPS/NUT (Network UPS Tools) - SYSLOG FORMAT
      // ============================================================================
      loki.source.syslog "nut_ups" {
        listener {
          address  = "0.0.0.0:5514"
          protocol = "udp"
          labels   = {
            cluster     = "kng",
            job         = "ups",
            device_type = "ups",
            source      = "nut-syslog",
          }
        }
        forward_to = [loki.process.ups.receiver]
      }

      loki.process "ups" {
        // Extract UPS-specific information
        stage.regex {
          expression = "(?P<ups_daemon>upsd|upsmon|upssched)(?:\\[(?P<pid>\\d+)\\])?:\\s+(?P<message>.*)"
        }
        
        stage.labels {
          values = {
            ups_daemon = "",
            ups_event  = "",
          }
        }
        
        // Detect UPS events
        stage.match {
          selector = "{message=~\".*battery.*\"}"
          stage.static_labels {
            values = {
              ups_event = "battery",
            }
          }
        }
        
        stage.match {
          selector = "{message=~\".*power.*\"}"
          stage.static_labels {
            values = {
              ups_event = "power",
            }
          }
        }
        
        stage.match {
          selector = "{message=~\".*online.*\"}"
          stage.static_labels {
            values = {
              ups_event = "online",
            }
          }
        }
        
        forward_to = [loki.write.default.receiver]
      }

      // ============================================================================
      // PROXMOX - SYSLOG FORMAT
      // ============================================================================
      loki.source.syslog "proxmox" {
        listener {
          address  = "0.0.0.0:6514"
          protocol = "udp"
          labels   = {
            cluster     = "kng",
            job         = "proxmox",
            device_type = "proxmox",
            source      = "proxmox-syslog",
          }
        }
        forward_to = [loki.process.proxmox.receiver]
      }

      loki.process "proxmox" {
        // Extract Proxmox-specific components
        stage.regex {
          expression = "(?P<pve_component>pve-cluster|pvedaemon|pvescheduler|pveproxy|pvestatd|qm|lxc|vzdump|pveceph)(?:\\[(?P<pid>\\d+)\\])?:\\s+(?P<message>.*)"
        }
        
        stage.labels {
          values = {
            component = "pve_component",
          }
        }
        
        // Extract VM/CT IDs
        stage.regex {
          source     = "message"
          expression = "(?:VM|CT)\\s+(?P<vm_id>\\d+)"
        }
        
        stage.labels {
          values = {
            vm_id = "",
          }
        }
        
        // Detect operation types
        stage.match {
          selector = "{message=~\".*start.*\"}"
          stage.static_labels {
            values = {
              operation = "start",
            }
          }
        }
        
        stage.match {
          selector = "{message=~\".*stop.*|.*shutdown.*\"}"
          stage.static_labels {
            values = {
              operation = "stop",
            }
          }
        }
        
        stage.match {
          selector = "{message=~\".*backup.*\"}"
          stage.static_labels {
            values = {
              operation = "backup",
            }
          }
        }
        
        stage.match {
          selector = "{message=~\".*migrate.*\"}"
          stage.static_labels {
            values = {
              operation = "migrate",
            }
          }
        }
        
        forward_to = [loki.write.default.receiver]
      }

      // ============================================================================
      // HTTP PUSH API - FOR APPLICATIONS
      // ============================================================================
      loki.source.api "http" {
        http {
          listen_address = "0.0.0.0"
          listen_port    = 8080
        }
        forward_to = [loki.process.http.receiver]
      }

      loki.process "http" {
        stage.static_labels {
          values = {
            cluster     = "kng",
            device_type = "application",
            source      = "http-push",
          }
        }
        
        forward_to = [loki.write.default.receiver]
      }

      // ============================================================================
      // LOKI WRITE ENDPOINT
      // ============================================================================
      loki.write "default" {
        endpoint {
          url = "http://loki-gateway.logging.svc.cluster.local/loki/api/v1/push"
        }
        
        // External labels applied to all logs
        external_labels = {
          cluster = "kng",
        }
      }

      // ============================================================================
      // PROMETHEUS METRICS - SELF MONITORING
      // ============================================================================
      prometheus.exporter.self "alloy" {}

      prometheus.scrape "alloy" {
        targets    = prometheus.exporter.self.alloy.targets
        forward_to = [prometheus.remote_write.metrics.receiver]
      }

      prometheus.remote_write "metrics" {
        endpoint {
          url = "http://kube-prometheus-stack-prometheus.kube-prometheus-stack.svc.cluster.local:9090/api/v1/write"
        }
      }

controller:
  type: "daemonset"

service:
  type: LoadBalancer

ingress:
  enabled: true
  ingressClassName: cilium
  hosts:
    - logs.kng.house
  tls:
    - secretName: logs-kng-house-tls
      hosts:
        - logs.kng.house

serviceMonitor:
  enabled: true
  namespace: alloy
