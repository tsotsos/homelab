# ğŸš€ Kubernetes Bootstrap Guide

Comprehensive guide for bootstrapping your Talos Kubernetes cluster with all core infrastructure components.

## Overview

The `bootstrap.sh` script provides a complete, resumable bootstrap process that installs all core infrastructure components in the correct order with automatic secret management.

## Quick Start

```bash
# Full bootstrap (run after deploy.sh)
./scripts/bootstrap.sh

# Resume from specific step
./scripts/bootstrap.sh --step 3

# Only reseal secrets
./scripts/bootstrap.sh --seal-secrets

# Reset and start over
./scripts/bootstrap.sh --reset

# Show help
./scripts/bootstrap.sh --help
```

## Key Features

âœ… **Complete Infrastructure** - Installs all core components in dependency order  
âœ… **Automatic Secret Sealing** - Scans and seals secrets with namespace detection  
âœ… **Resumable** - Can restart from any step if interrupted  
âœ… **Idempotent** - Safe to run multiple times  
âœ… **Smart Mapping** - Automatically finds correct directories for secrets  
âœ… **Clean** - Removes temporary helm charts after installation  
âœ… **Error Prevention** - Strips problematic creationTimestamp fields  

## Bootstrap Steps

| Step | Component | Time | Purpose |
|------|-----------|------|---------|
| 0 | Node Labels | 10s | Apply labels from cluster-config.yaml |
| 1 | Cilium CNI | 2-3m | Network plugin with eBPF optimization |
| 2 | Kube-VIP | 1-2m | Load balancer for services |
| 3 | Sealed Secrets | 2m | Encrypt secrets + seal all from secrets-un/ |
| 4 | External-DNS | 1m | Automatic DNS management |
| 5 | Cert-Manager | 2-3m | TLS certificate automation |
| 6 | Longhorn | 3-5m | Distributed storage system |
| 7 | ArgoCD | 2-3m | GitOps deployment (displays admin password) |
| **Total** | | **~15-20m** | |

## Prerequisites

Before running bootstrap.sh, ensure:

- âœ… Talos cluster deployed (`./scripts/deploy.sh` completed)
- âœ… Kubeconfig available at `infra/talos-config/kubeconfig`
- âœ… Unsealed secrets exist in `secrets-un/` directory
- âœ… Tools installed: `kubectl`, `kustomize`, `helm`, `yq`, `kubeseal`

The script will verify all prerequisites automatically.

## Secret Management

### Automatic Secret Sealing

The bootstrap script automatically seals all secrets in the `secrets-un/` directory:

1. **Scans** all YAML files in `secrets-un/`
2. **Extracts** namespace from each secret
3. **Maps** namespace to correct directory in `cluster/`
4. **Seals** using `kubeseal` (direct cluster access, no PEM file)
5. **Removes** problematic `creationTimestamp` fields
6. **Saves** as `sealed-secret.yaml` in target directory

### Secret Location Mapping

| Namespace | Unsealed Secret | Sealed Location |
|-----------|----------------|-----------------|
| authentik | authentik.yaml | security/authentik/sealed-secret.yaml |
| cert-manager | cert-manager.yaml | security/cert-manager/sealed-secret.yaml |
| external-dns | external-dns.yaml | network/external-dns/sealed-secret.yaml |
| monitoring | kube-prometheus-stack.yaml | observability/kube-prometheus-stack/sealed-secret.yaml |
| postgresql | postgresql.yaml | database/postgresql/sealed-secret.yaml |

### Updating Secrets

After the cluster is running:

```bash
# 1. Edit unsealed secret
vi secrets-un/kube-prometheus-stack.yaml

# 2. Reseal with cluster controller
./scripts/bootstrap.sh --seal-secrets

# 3. Commit changes
git add cluster/observability/kube-prometheus-stack/sealed-secret.yaml
git commit -m "Update grafana secrets"
git push
```

## Workflows

### Initial Deployment

Complete setup from scratch:

```bash
# 1. Generate infrastructure and Talos configs
cd infra && terraform apply && cd ..

# 2. Deploy Talos cluster
./scripts/deploy.sh

# 3. Bootstrap all infrastructure
./scripts/bootstrap.sh

# 4. Access ArgoCD (password displayed in output)
kubectl port-forward svc/argocd-server -n argocd 8080:443
# Visit: https://localhost:8080
# Username: admin
# Password: (shown in bootstrap output)
```

### Resume Failed Bootstrap

If bootstrap fails at any step:

```bash
# Option 1: Let it auto-resume
./scripts/bootstrap.sh
# Prompts: "Resume from step 3? (y/n)"

# Option 2: Manually specify step
./scripts/bootstrap.sh --step 3
```

### Reset and Restart

To clear state and start fresh:

```bash
./scripts/bootstrap.sh --reset
./scripts/bootstrap.sh
```

## Directory Structure

The bootstrap script expects this structure:

```
homelab/
â”œâ”€â”€ infra/
â”‚   â”œâ”€â”€ cluster-config.yaml          # Node labels configuration
â”‚   â””â”€â”€ talos-config/
â”‚       â””â”€â”€ kubeconfig               # Generated by deploy.sh
â”œâ”€â”€ cluster/
â”‚   â”œâ”€â”€ network/
â”‚   â”‚   â”œâ”€â”€ cilium/
â”‚   â”‚   â”œâ”€â”€ kube-vip/
â”‚   â”‚   â”œâ”€â”€ kube-vip-cloud-provider/
â”‚   â”‚   â””â”€â”€ external-dns/
â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â”œâ”€â”€ sealed-secrets/
â”‚   â”‚   â”œâ”€â”€ cert-manager/
â”‚   â”‚   â””â”€â”€ authentik/
â”‚   â”œâ”€â”€ storage/
â”‚   â”‚   â””â”€â”€ longhorn/
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â””â”€â”€ postgresql/
â”‚   â”œâ”€â”€ observability/
â”‚   â”‚   â””â”€â”€ kube-prometheus-stack/
â”‚   â””â”€â”€ argocd/
â”œâ”€â”€ secrets-un/                      # Unsealed secrets (git-ignored)
â”‚   â”œâ”€â”€ authentik.yaml
â”‚   â”œâ”€â”€ cert-manager.yaml
â”‚   â”œâ”€â”€ external-dns.yaml
â”‚   â”œâ”€â”€ kube-prometheus-stack.yaml
â”‚   â””â”€â”€ postgresql.yaml
â””â”€â”€ scripts/
    â””â”€â”€ bootstrap.sh
```

## After Bootstrap

Once complete, you'll have:

- âœ… Fully operational Kubernetes cluster
- âœ… CNI (Cilium) with eBPF optimization
- âœ… LoadBalancer (kube-vip) operational
- âœ… All secrets sealed and safe for git storage
- âœ… DNS automation (external-dns) configured
- âœ… TLS automation (cert-manager) ready
- âœ… Storage (Longhorn) distributed across workers
- âœ… GitOps (ArgoCD) managing applications
- âœ… ArgoCD admin credentials displayed

## Troubleshooting

### Check Bootstrap State

```bash
# View current state
cat scripts/.bootstrap-state

# Check specific component
kubectl get pods -n kube-system | grep cilium
kubectl get pods -n argocd
kubectl get sealedsecrets -A
```

### Component Logs

```bash
# Cilium
kubectl logs -n kube-system -l k8s-app=cilium

# Sealed-secrets controller
kubectl logs -n kube-system -l app.kubernetes.io/name=sealed-secrets

# ArgoCD
kubectl logs -n argocd -l app.kubernetes.io/name=argocd-server
```

### Sealed Secrets Not Unsealing

1. **Check controller is running:**
   ```bash
   kubectl get pods -n kube-system -l app.kubernetes.io/name=sealed-secrets
   ```

2. **Check logs for errors:**
   ```bash
   kubectl logs -n kube-system -l app.kubernetes.io/name=sealed-secrets --tail=50
   ```

3. **Verify secret format:**
   - Correct namespace in metadata
   - No `creationTimestamp` in `spec.template.metadata`
   - Valid encrypted data

### Can't Find ArgoCD Password

```bash
kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d
```

### Resume Specific Step

```bash
# If bootstrap failed at step 3
./scripts/bootstrap.sh --step 3
```

## Command Reference

### Main Commands

```bash
# Full bootstrap
./scripts/bootstrap.sh

# Resume from step N (0-7)
./scripts/bootstrap.sh --step <N>

# Only reseal secrets (requires sealed-secrets installed)
./scripts/bootstrap.sh --seal-secrets

# Clear state and start fresh
./scripts/bootstrap.sh --reset

# Show help
./scripts/bootstrap.sh --help
```

### Verification Commands

```bash
# Check all pods
kubectl get pods -A

# Check nodes
kubectl get nodes -o wide

# Check sealed secrets
kubectl get sealedsecrets -A

# Check ArgoCD applications
kubectl get applications -n argocd

# Get ArgoCD password
kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d
```

## Important Notes

### State Management
- Bootstrap state saved at `scripts/.bootstrap-state`
- Automatically prompts to resume after failure
- Clear with `--reset` flag

### Helm Charts
- Each app installed using `kustomize build --enable-helm`
- Temporary `charts/` directories automatically cleaned up
- No manual helm repo management needed

### Secret Sealing
- Uses direct cluster access (no PEM file needed after controller installed)
- Automatically removes `creationTimestamp` fields
- Validates namespace before sealing

### Timing
- First run: ~15-20 minutes
- Subsequent runs: Faster (skips already-installed components)
- Longhorn takes longest (3-5 minutes for distributed storage setup)

## Advanced Usage

### Custom Secret Directory

Edit the `SECRETS_UNSEALED_DIR` variable in the script:

```bash
SECRETS_UNSEALED_DIR="$PROJECT_ROOT/my-secrets"
```

### Skip Specific Steps

To skip a step, modify the main execution block or use state management:

```bash
# Save state to skip steps 0-2
echo "2" > scripts/.bootstrap-state
./scripts/bootstrap.sh  # Starts from step 3
```

### Parallel Installation

The script installs components sequentially to respect dependencies. For parallel installation, modify the step functions to remove wait conditions (not recommended).

## What's Different from Old Scripts

### Removed
- âŒ Old `bootstrap.sh` (only installed Cilium + ArgoCD)
- âŒ `label-nodes.sh` (integrated as Step 0)

### Added
- âœ… Complete infrastructure deployment (8 steps)
- âœ… Automatic secret sealing with smart directory detection
- âœ… Resumable bootstrap with state management
- âœ… Automatic removal of problematic `creationTimestamp` fields
- âœ… Helm chart cleanup after installation
- âœ… ArgoCD admin password display

## Support

For more information:
- Script help: `./scripts/bootstrap.sh --help`
- Main README: `../README.md`
- Scripts documentation: `scripts/README.md`
- Infrastructure docs: `infra/README.md`
- Cluster manifests: `cluster/README.md`
